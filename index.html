<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BangaloreMetroMap — Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{--purple:#7c3aed;--green:#10b981;--yellow:#f59e0b;--ink:#0f172a;--muted:#64748b;--card:#0e1726;--hair:#1e293b}
  html,body{height:100%} body{margin:0;background:#0b1120;color:#e5e7eb;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:22px auto;padding:0 12px}
  h1{font-size:clamp(20px,5vw,34px);margin:0 0 6px;text-align:center}
  p.sub{color:#94a3b8;text-align:center;margin:0 0 14px}
  .map-wrap{background:#0e1726;border:1px solid var(--hair);border-radius:14px;overflow:hidden}
  #map{height:clamp(420px,64vh,720px)}
  .legend{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0 0}
  .key{display:inline-flex;align-items:center;gap:6px;color:#cbd5e1;font-size:13px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.purple{background:var(--purple)} .dot.green{background:var(--green)} .dot.yellow{background:var(--yellow)}
  .leaflet-tooltip{font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Bengaluru’s “Namma Metro” Map & Timings — Map</h1>
    <p class="sub">Stations colored by line. Interchanges are dual-ring markers.</p>
    <div class="map-wrap"><div id="map" role="region" aria-label="Bengaluru Metro map"></div></div>
    <div class="legend">
      <span class="key"><span class="dot purple"></span>PURPLE</span>
      <span class="key"><span class="dot green"></span>GREEN</span>
      <span class="key"><span class="dot yellow"></span>YELLOW</span>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const LINE_COLORS = { PURPLE:"#7c3aed", GREEN:"#10b981", YELLOW:"#f59e0b" };
const seqKey = L => `seq_${L.toLowerCase()}`;
const BLR = [12.9716, 77.5946];

const map = L.map('map', { zoomControl:true });
map.setView(BLR, 11.8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom:19, detectRetina:true, attribution:'&copy; OpenStreetMap' }).addTo(map);

const lines = { PURPLE:L.layerGroup().addTo(map),
                GREEN:L.layerGroup().addTo(map),
                YELLOW:L.layerGroup().addTo(map) };
const stationsLayer = L.layerGroup().addTo(map);

fetch('/data/stations.geojson', { cache:'no-store' })
  .then(r=>r.json()).then(gj => render(gj))
  .catch(e => { console.warn(e); L.marker(BLR).addTo(map).bindPopup('Add /data/stations.geojson'); });

function render(gj){
  const byLine = { PURPLE:[], GREEN:[], YELLOW:[] };
  const bounds = [];

  gj.features.forEach(f=>{
    const p = f.properties||{};
    const [lng,lat] = f.geometry.coordinates;
    const Ls = Array.isArray(p.lines) ? p.lines : String(p.lines||'').split(',').map(x=>x.trim().toUpperCase()).filter(Boolean);
    const primary = Ls[0]; const colorA = LINE_COLORS[primary] || '#fff';
    const m1 = L.circleMarker([lat,lng], { radius:6.5, color:colorA, weight:2.5, fillColor:'#fff', fillOpacity:1 })
      .addTo(stationsLayer).bindTooltip(p.name||p.id||'Station', {direction:'top', offset:[0,-10], opacity:.92});

    if (p.interchange && Ls[1]) {
      const colorB = LINE_COLORS[Ls[1]] || '#fff';
      L.circleMarker([lat,lng], { radius:3.4, color:colorB, weight:3, fillColor:'#fff', fillOpacity:1 }).addTo(stationsLayer);
    }
    Ls.forEach(LN => { const q = +p[seqKey(LN)]; if (Number.isFinite(q)) byLine[LN]?.push({seq:q, lat, lng}); });
  });

  Object.entries(byLine).forEach(([LN, arr])=>{
    if (!arr.length) return;
    arr.sort((a,b)=>a.seq-b.seq);
    const latlngs = arr.map(pt => { const ll=[pt.lat,pt.lng]; bounds.push(ll); return ll; });
    L.polyline(latlngs, { color:LINE_COLORS[LN], weight:5, opacity:.9, lineJoin:'round' }).addTo(lines[LN]);
  });

  if (bounds.length) map.fitBounds(L.latLngBounds(bounds), { padding:[20,20] });
}
</script>
</body>
</html>
